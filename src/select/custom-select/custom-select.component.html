<div
  cdk-overlay-origin
  thySelectControl
  (click)="toggle($event)"
  #origin="cdkOverlayOrigin"
  #trigger
  [thyPanelOpened]="panelOpen"
  [thySelectedOptions]="selectedOptions()"
  [thyIsMultiple]="isMultiple()"
  [thyShowSearch]="thyShowSearch()"
  [thyAllowClear]="thyAllowClear()"
  [thySize]="thySize()"
  [thyPlaceholder]="thyPlaceHolder()"
  [customDisplayTemplate]="selectedValueDisplayRef()"
  [thyDisabled]="disabled"
  [thyBorderless]="thyBorderless()"
  (thyOnClear)="clearSelectValue($event)"
  (thyOnRemove)="remove($event)"
  (thyOnSearch)="search($event)"
  (thyOnBlur)="onBlur($event)"
  [thyMaxTagCount]="thyMaxTagCount()"
  [thyPreset]="thyPreset()"></div>

<ng-template
  cdk-connected-overlay
  cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
  [cdkConnectedOverlayHasBackdrop]="thyHasBackdrop()"
  [cdkConnectedOverlayPositions]="dropDownPositions()"
  [cdkConnectedOverlayOrigin]="thyOrigin() || origin"
  [cdkConnectedOverlayOpen]="panelOpen"
  [cdkConnectedOverlayWidth]="triggerRectWidth()"
  [cdkConnectedOverlayMinWidth]="dropDownMinWidth()"
  [cdkConnectedOverlayScrollStrategy]="scrollStrategy"
  cdkConnectedOverlayTransformOriginOn=".thy-select-dropdown"
  (attach)="onAttached()"
  (detach)="close()">
  <div
    thyStopPropagation
    [attr.tabindex]="-1"
    [ngClass]="dropDownClass()"
    [@scaleYMotion]="placement() === 'top' || placement() === 'bottom' ? 'enter' : 'void'"
    [@scaleXMotion]="placement() === 'left' || placement() === 'right' ? 'enter' : 'void'"
    [@scaleMotion]="
      placement() !== 'top' && placement() !== 'bottom' && placement() !== 'left' && placement() !== 'right' ? 'enter' : 'void'
    "
    (mousemove)="dropDownMouseMove($event)">
    <!-- @if (contentOptions?.length > 0 || contentGroups?.length > 0 || innerOptions?.length > 0) { -->
    @if (renderGroupsAndOptions()?.length > 0) {
      <div
        #panel
        class="thy-select-dropdown-options thy-select-dropdown-options-{{ thySize() }}"
        thyScroll
        (thyOnScrolled)="onOptionsScrolled($event)"
        [thyEnable]="thyEnableScrollLoad()">
        <!-- @if (isReactiveDriven) {
          <ng-template [ngTemplateOutlet]="optionsContainer.optionsTemplate()"></ng-template>
        } -->

        <!-- track -->
        <cdk-virtual-scroll-viewport
          itemSize="40"
          maxBufferPx="320"
          minBufferPx="320"
          [style.height.px]="renderGroupsAndOptions().length * 40"
          [style.max-height.px]="320">
          <ng-template
            cdkVirtualFor
            [cdkVirtualForOf]="renderGroupsAndOptions()"
            [cdkVirtualForTrackBy]="trackByFn"
            [cdkVirtualForTemplateCacheSize]="0"
            let-item>
            <!-- @for (item of renderGroupsAndOptions(); track $index) { -->

            @if (item.type === 'group') {
              <!-- [thyDisabled]="item.disabled"  分组的禁用好像没什么用？ -->
              <thy-option-group-render [thyGroupLabel]="item.label"></thy-option-group-render>
            } @else {
              <thy-option-render
                [thyValue]="item.value"
                [thyRawValue]="item.rawValue"
                [thyLabelText]="item.label"
                [thyShowOptionCustom]="item.showOptionCustom"
                [thySearchKey]="item.searchKey"
                [thyDisabled]="item.disabled"
                [thyTemplate]="item.template"
                [thyShowCheckedIcon]="isMultiple()"
                [thySelectedValuesOfList]="selectedValues()"
                (optionClick)="optionClick($event)">
              </thy-option-render>
            }
            <!-- } -->
          </ng-template>
        </cdk-virtual-scroll-viewport>
        <ng-content></ng-content>
        <!-- @if (isHiddenOptions) {
          <thy-loading [thyDone]="thyLoadState()" thySize="sm"></thy-loading>
          <div class="thy-select-empty-content">
            @if (thyLoadState()) {
              <thy-empty [thyMessage]="thyEmptySearchMessageText()" thySize="sm" [thyIconName]="emptyIcon()"></thy-empty>
            }
          </div>
        } -->
      </div>
    } @else {
      <thy-loading [thyDone]="thyLoadState()" thySize="sm"></thy-loading>
      <div class="thy-select-empty-content">
        @if (thyLoadState()) {
          @let isSearching = keywords();
          <thy-empty
            [thyMessage]="isSearching ? thyEmptySearchMessageText() : thyEmptyStateText()"
            thySize="sm"
            [thyIconName]="emptyIcon()"></thy-empty>
        }
      </div>
    }
    @if (thyFooterTemplate()) {
      <div [class]="thyFooterClass() ? thyFooterClass() : 'thy-custom-select-footer'">
        @if (thyFooterTemplate()) {
          <ng-template [ngTemplateOutlet]="thyFooterTemplate()"></ng-template>
        }
      </div>
    }
  </div>
</ng-template>

<!-- <thy-options-container #optionsContainer>
  @for (option of optionGroups; track $index) {
    @if (!option.children) {
      <thy-option-render
        [thyDisabled]="option.disabled"
        [thyLabelText]="option.label"
        [thyValue]="option.value"
        [thyRawValue]="option"></thy-option-render>
    } @else {
      <thy-option-group [thyGroupLabel]="option.groupLabel">
        @for (sub of option.children; track sub.value) {
          <thy-option-render
            [thyDisabled]="sub.disabled"
            [thyLabelText]="sub.label"
            [thyValue]="sub.value"
            [thyRawValue]="sub"></thy-option-render>
        }
      </thy-option-group>
    }
  }
</thy-options-container> -->
