<div
  cdk-overlay-origin
  thySelectControl
  (click)="toggle($event)"
  #origin="cdkOverlayOrigin"
  #trigger
  [thyPanelOpened]="panelOpen"
  [thySelectedOptions]="selected"
  [thyIsMultiple]="isMultiple"
  [thyShowSearch]="thyShowSearch()"
  [thyAllowClear]="thyAllowClear()"
  [thySize]="thySize()"
  [thyPlaceholder]="thyPlaceHolder()"
  [customDisplayTemplate]="selectedValueDisplayRef()"
  [thyDisabled]="disabled"
  [thyBorderless]="thyBorderless()"
  (thyOnClear)="clearSelectValue($event)"
  (thyOnRemove)="remove($event)"
  (thyOnSearch)="onSearchFilter($event)"
  (thyOnBlur)="onBlur($event)"
  [thyMaxTagCount]="thyMaxTagCount()"
  [thyPreset]="thyPreset()"></div>

<ng-template
  cdk-connected-overlay
  cdkConnectedOverlayBackdropClass="cdk-overlay-transparent-backdrop"
  [cdkConnectedOverlayHasBackdrop]="thyHasBackdrop()"
  [cdkConnectedOverlayPositions]="dropDownPositions"
  [cdkConnectedOverlayOrigin]="thyOrigin() || origin"
  [cdkConnectedOverlayOpen]="panelOpen"
  [cdkConnectedOverlayWidth]="triggerRectWidth"
  [cdkConnectedOverlayMinWidth]="dropDownMinWidth"
  [cdkConnectedOverlayScrollStrategy]="scrollStrategy"
  cdkConnectedOverlayTransformOriginOn=".thy-select-dropdown"
  (attach)="onAttached()"
  (detach)="close()">
  <!-- (click)="optionClick($event)"
    (keydown)="optionKeydown($event)" -->
  <div
    thyStopPropagation
    [attr.tabindex]="-1"
    [ngClass]="dropDownClass"
    [@scaleYMotion]="placement === 'top' || placement === 'bottom' ? 'enter' : 'void'"
    [@scaleXMotion]="placement === 'left' || placement === 'right' ? 'enter' : 'void'"
    [@scaleMotion]="placement !== 'top' && placement !== 'bottom' && placement !== 'left' && placement !== 'right' ? 'enter' : 'void'"
    (mousemove)="dropDownMouseMove($event)">
    @if (contentOptions?.length > 0 || contentGroups?.length > 0 || innerOptions?.length > 0) {
      <div
        #panel
        class="thy-select-dropdown-options thy-select-dropdown-options-{{ thySize() }}"
        thyScroll
        (thyOnScrolled)="onOptionsScrolled($event)"
        [thyEnable]="thyEnableScrollLoad()">
        @if (isReactiveDriven) {
          <ng-template [ngTemplateOutlet]="optionsContainer.optionsTemplate"></ng-template>
        }

        @for (option of contentOptions; track option.thyValue) {
          <thy-option-render
            [thyValue]="option.thyValue()"
            [thyRawValue]="option.thyRawValue()"
            [thyLabelText]="option.thyLabelText()"
            [thyShowOptionCustom]="option.thyShowOptionCustom()"
            [thySearchKey]="option.thySearchKey()"
            [thyDisabled]="option.thyDisabled()"
            [thyTemplate]="option.template()"
            (selectionChange)="optionSelectionChange($event)">
          </thy-option-render>
        }

        @if (isHiddenOptions) {
          <thy-loading [thyDone]="thyLoadState()" thySize="sm"></thy-loading>
          <div class="thy-select-empty-content">
            @if (thyLoadState()) {
              <thy-empty [thyMessage]="thyEmptySearchMessageText()" thySize="sm" [thyIconName]="emptyIcon()"></thy-empty>
            }
          </div>
        }
      </div>
    } @else {
      <thy-loading [thyDone]="thyLoadState()" thySize="sm"></thy-loading>
      <div class="thy-select-empty-content">
        @if (thyLoadState()) {
          <thy-empty [thyMessage]="thyEmptyStateText()" thySize="sm" [thyIconName]="emptyIcon()"></thy-empty>
        }
      </div>
    }
    @if (thyFooterTemplate()) {
      <div [class]="thyFooterClass() ? thyFooterClass() : 'thy-custom-select-footer'">
        @if (thyFooterTemplate()) {
          <ng-template [ngTemplateOutlet]="thyFooterTemplate()"></ng-template>
        }
      </div>
    }
  </div>
</ng-template>

<thy-options-container #optionsContainer>
  <!-- @if (!thyVirtualScroll()) { -->
  @for (option of optionGroups; track $index) {
    @if (!option.children) {
      <thy-option
        [thyDisabled]="option.disabled"
        [thyLabelText]="option.label"
        [thyValue]="option.value"
        [thyRawValue]="option"></thy-option>
    } @else {
      <thy-option-group [thyGroupLabel]="option.groupLabel">
        @for (sub of option.children; track sub.value) {
          <thy-option [thyDisabled]="sub.disabled" [thyLabelText]="sub.label" [thyValue]="sub.value" [thyRawValue]="sub"></thy-option>
        }
      </thy-option-group>
    }
  }
  <!-- } @else {
    <cdk-virtual-scroll-viewport #viewport [itemSize]="thyItemSize()" [style.height]="thyVirtualHeight()">
      <ng-container *cdkVirtualFor="let option of optionGroups; trackBy: trackByFn">
        @if (!option.children) {
          <thy-option
            [thyDisabled]="option.disabled"
            [thyLabelText]="option.label"
            [thyValue]="option.value"
            [thyRawValue]="option"></thy-option>
        } @else {
          <thy-option-group [thyGroupLabel]="option.groupLabel">
            @for (sub of option.children; track sub.value) {
              <thy-option [thyDisabled]="sub.disabled" [thyLabelText]="sub.label" [thyValue]="sub.value" [thyRawValue]="sub"></thy-option>
            }
          </thy-option-group>
        }
      </ng-container>
    </cdk-virtual-scroll-viewport>
  } -->
</thy-options-container>
