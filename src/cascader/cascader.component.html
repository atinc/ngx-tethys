<div cdkOverlayOrigin #origin="cdkOverlayOrigin" #trigger>
  @if (thyShowInput()) {
    <div
      thySelectControl
      [thyShowSearch]="thyShowSearch()"
      [thySize]="thySize()"
      [thyAllowClear]="true"
      [thySelectedOptions]="selected"
      [thyMaxTagCount]="thyMaxTagCount()"
      (thyOnRemove)="removeSelectedItem($event)"
      (thyOnClear)="clearSelection($event)"
      (thyOnBlur)="onBlur($event)"
      (thyOnSearch)="searchFilter($event)"
      [thyDisabled]="disabled"
      [thyIsMultiple]="thyMultiple()"
      [thyPanelOpened]="menuVisible"
      [thyPlaceholder]="thyPlaceholder()"
      [customDisplayTemplate]="customDisplayTemplate"
      [thyPreset]="thyPreset()">
      <ng-template #customDisplayTemplate let-value>
        @if (!isLabelRenderTemplate()) {
          <span [ngClass]="labelCls">{{ value.labelText }}</span>
        } @else {
          <span [ngClass]="labelCls">
            <ng-template [ngTemplateOutlet]="thyLabelRender()" [ngTemplateOutletContext]="value.labelRenderContext"></ng-template>
          </span>
        }
      </ng-template>
    </div>
  }
</div>

<ng-template
  cdkConnectedOverlay
  [cdkConnectedOverlayHasBackdrop]="thyHasBackdrop()"
  cdkConnectedOverlayBackdropClass="thy-cascader-backdrop"
  [cdkConnectedOverlayOrigin]="origin"
  [cdkConnectedOverlayPositions]="positions"
  [cdkConnectedOverlayMinWidth]="menuMinWidth"
  cdkConnectedOverlayTransformOriginOn=".thy-cascader-menus"
  (backdropClick)="closeMenu()"
  (detach)="closeMenu()"
  (attach)="attached()"
  (positionChange)="positionChange($event)"
  [cdkConnectedOverlayOpen]="menuVisible">
  <div
    [attr.tabindex]="-1"
    #menu
    [ngClass]="menuCls"
    [ngStyle]="thyMenuStyle()"
    (mouseleave)="toggleMouseLeave($event)"
    [@scaleYMotion]="'enter'">
    @if (!isShowSearchPanel) {
      @if (columns.length > 0) {
        @for (options of columns; track $index; let i = $index; let isFirst = $first) {
          <ul #cascaderOptionContainers [ngClass]="menuColumnCls()" [ngStyle]="{ 'width.px': thyWidth() }">
            @let allOptions = options | cascaderOptions: (isFirst ? thyCascaderService.customOptions : []);

            @if (allOptions.length > 0) {
              <cdk-virtual-scroll-viewport [itemSize]="36" class="h-100">
                <ng-container *cdkVirtualFor="let option of allOptions; let index = index; trackBy: trackByFn">
                  @if (
                    thyCascaderService.customOptions &&
                    thyCascaderService.customOptions.length > 0 &&
                    isFirst &&
                    index < thyCascaderService.customOptions.length
                  ) {
                    <li
                      #cascaderOptions
                      thy-cascader-option
                      [option]="option"
                      [multiple]="thyMultiple()"
                      [isOnlySelectLeaf]="thyIsOnlySelectLeaf()"
                      [labelProperty]="thyLabelProperty()"
                      [active]="isActivatedOption(option, 0)"
                      [halfSelected]="isHalfSelectedOption(option, 0)"
                      [selected]="isSelectedOption(option, 0)"
                      (toggleSelectChange)="clickCustomOption(option, 0, $event)"
                      (click)="clickCustomOption(option, 0, $event)"
                      (mouseover)="mouseoverOption(option, 0, $event)"></li>
                    @if (index === thyCascaderService.customOptions.length - 1) {
                      <thy-divider class="my-1 mx-4"></thy-divider>
                    }
                  } @else {
                    <li
                      #cascaderOptions
                      thy-cascader-option
                      [option]="option"
                      [multiple]="thyMultiple()"
                      [isOnlySelectLeaf]="thyIsOnlySelectLeaf()"
                      [labelProperty]="thyLabelProperty()"
                      [active]="isActivatedOption(option, i)"
                      [halfSelected]="isHalfSelectedOption(option, i)"
                      [selected]="isSelectedOption(option, i)"
                      [optionRender]="thyOptionRender()"
                      (toggleSelectChange)="clickOption(option, i, $event)"
                      (click)="clickOption(option, i, $event)"
                      (mouseover)="mouseoverOption(option, i, $event)"></li>
                  }
                </ng-container>
              </cdk-virtual-scroll-viewport>
            }
          </ul>
        }
      } @else {
        <div class="thy-cascader-empty-container" [ngStyle]="{ 'width.px': triggerRect?.width }">
          <thy-empty
            class="thy-select-empty-content"
            thySize="sm"
            [thyMessage]="thyEmptyStateText()"
            [thyIconName]="emptyIcon()"></thy-empty>
        </div>
      }
    }
    @if (isShowSearchPanel) {
      @if (searchResultList.length) {
        <ul class="thy-cascader-search-list py-3" [ngStyle]="thySearchListStyle()">
          @for (item of searchResultList; track $index) {
            <li
              thy-cascader-search-option
              [multiple]="thyMultiple()"
              [isOnlySelectLeaf]="thyIsOnlySelectLeaf()"
              [option]="item"
              [active]="item.selected"
              [optionRender]="thyOptionRender()"
              (toggleSelectChange)="selectSearchResult($event)"></li>
          }
        </ul>
      } @else {
        <div class="thy-cascader-empty-container" [ngStyle]="{ 'width.px': triggerRect?.width }">
          <thy-empty
            class="thy-select-empty-content"
            thySize="sm"
            [thyMessage]="thyEmptyStateText()"
            [thyIconName]="emptyIcon()"></thy-empty>
        </div>
      }
    }
  </div>
</ng-template>
